# 回测参数调整记录

## 2024 调整 - 针对3分钟K线优化

### 问题诊断
- **边沿触发率极低**：86160个信号中仅3个BUY，0个SELL
- **根本原因**：成交量爆发条件过于严格，几乎所有边沿触发都被过滤

### 已应用优化（方案A：保守调整）

#### 1. 边沿检测修复 ✅
**Bug修复**：
```javascript
// ❌ 旧逻辑：基于K线索引（错误）
const isInLowerEdge = volumeProfile.lowerEdgeIndices.includes(currentIdx);

// ✅ 新逻辑：基于价格距离
const distanceToVAL = Math.abs(currentPrice - VAL) / VAL;
const isInLowerEdge = distanceToVAL <= 0.05; // 5%
```

#### 2. 成交量参数调整 ✅
```javascript
// 参数          旧值    新值    变化       理由
P2_LOCAL_Z     2.3  →  1.8   (-21%)   3分钟成交量波动较小
P3_GLOBAL_Z    2.0  →  1.5   (-25%)   需要更敏感的全局检测
P4_VOLUME_RATIO 2.0  →  1.6   (-20%)   环比爆发2倍太严格
P5_MA5_RATIO   1.8  →  1.5   (-17%)   5期均值比需要降低
P6_DIST_STRENGTH 1.3 →  1.2   (-8%)    分布强度微调
边沿阈值       2%   →  5%    (+150%)  价格容差增加
```

#### 3. 诊断系统增强 ✅
- 新增边沿触发统计
- 前20次边沿触发详细日志
- 每个P2-P6条件的通过/未通过状态
- 边沿→信号转化率跟踪

#### 4. 内存优化 ✅
- 权益曲线采样：每根 → 每100根（减少400倍内存）
- Node.js内存：4GB → 8GB
- 策略静默模式：回测时减少日志量

### 预期效果

#### 保守估计
- 边沿触发次数：200-1000次（从当前的3次）
- 边沿→信号转化率：5-15%
- 实际交易次数：50-150笔/2.5年
- 平均持仓周期：6-18天

#### 性能目标
- 胜率：40-50%
- 夏普比率：> 1.0
- 最大回撤：< 15%
- 年化收益率：> 20%

### 运行方式

#### 标准回测（带诊断）
```bash
cd backend
npm run backtest
```

**输出内容**：
1. 前20次边沿触发的详细分析
2. 每个P2-P6条件的实际数值和通过情况
3. 边沿触发统计和转化率
4. 完整的交易记录和性能报告

#### 查看诊断结果
关注以下关键日志：
```
📍 第N次边沿触发 (K线 XXXX):
   价格: $XXXX.XX
   ScoreB: X.XXX, ScoreC: X.XXX, 最终: X.XXX
   信号: BUY/SELL/HOLD, 置信度: HIGH/MEDIUM/LOW
   
[模块B] P2: 局部Z值=X.XX (阈值=1.8) ✓/✗
[模块B] P3: 全局Z值=X.XX (阈值=1.5) ✓/✗
[模块B] P4: 环比=X.XX (阈值=1.6) ✓/✗
[模块B] P5: 5期均值比=X.XX (阈值=1.5) ✓/✗
[模块B] P6: 分布强度比=X.XX (阈值=1.2) ✓/✗
```

### 进一步调整方案

#### 如果交易仍然太少（< 30笔）
应用**方案B（激进调整）**：
```javascript
P2_LOCAL_Z_THRESHOLD: 1.5,     // 1.8 → 1.5
P3_GLOBAL_Z_THRESHOLD: 1.2,    // 1.5 → 1.2
P4_VOLUME_RATIO: 1.4,          // 1.6 → 1.4
P5_MA5_RATIO: 1.3,             // 1.5 → 1.3
P6_DIST_STRENGTH: 1.0,         // 1.2 → 1.0
edgeThresholdPct: 0.07,        // 5% → 7%
```

#### 如果交易过多（> 300笔）
回调参数：
```javascript
P2_LOCAL_Z_THRESHOLD: 2.0,     // 1.8 → 2.0
P3_GLOBAL_Z_THRESHOLD: 1.7,    // 1.5 → 1.7
```

#### 如果胜率太低（< 35%）
- 检查止损止盈设置（当前0.6%/1.2%）
- 增强模块C的市场确认条件
- 考虑加入趋势过滤器

### 性能追踪

| 版本 | 日期 | 交易数 | 胜率 | 年化收益 | 夏普 | 最大回撤 |
|------|------|--------|------|----------|------|----------|
| v1.0 | 原始 | 3      | 0%   | -3.67%   | -    | 2.65%    |
| v2.0 | 优化 | ?      | ?    | ?        | ?    | ?        |

### 文件位置

- **策略文件**：`backend/src/controllers/strategy/VolumeProfileStrategy.js`
- **回测引擎**：`backend/src/backtest/BacktestEngine.js`
- **参数说明**：`backend/docs/strategy_params_tuning.md`
- **交易记录**：`backend/data/backtest/*_trades.csv`
- **性能报告**：`backend/data/backtest/*_report.json`

### 下一步

1. ✅ 运行优化后的回测
2. 📊 查看前20次边沿触发的详细数据
3. 🔍 分析各条件的实际通过率
4. ⚙️ 基于数据微调参数
5. 🔄 迭代优化直到满意

### 注意事项

⚠️ **过度优化风险**
- 不要基于单一市场状态调参
- 保持参数的经济含义
- 避免过拟合历史数据

⚠️ **风险控制优先**
- 单笔止损：0.6%（固定）
- 单笔止盈：1.2%（2:1盈亏比）
- 最大仓位：初始资金的10%
- 杠杆：10x（实际风险1x）

