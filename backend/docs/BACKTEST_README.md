# 回测系统使用手册

## 概述

DeepTrade 回测系统是一个专业的量化交易策略回测引擎，基于真实的币安历史数据，完整模拟成交量策略的执行过程。

### 核心特性

✅ **真实数据**：从币安API获取真实历史K线数据  
✅ **完整模拟**：精确模拟手续费、滑点、止损止盈  
✅ **10倍杠杆**：支持杠杆交易回测  
✅ **多维分析**：分市场状态、参数敏感性、蒙特卡洛模拟  
✅ **详细报告**：生成完整的性能指标和交易记录  

## 快速开始

### 1. 基础回测

最简单的方式，使用默认配置：

```bash
cd backend
npm run backtest
```

默认配置：
- 交易对: BTC/USDT
- 时间周期: 1分钟K线
- 回测区间: 2021-01-01 至 2023-06-30
- 初始资金: $10,000
- 每笔金额: $10
- 杠杆: 10x
- 止损: 0.6%
- 止盈: 1.2%

### 2. 自定义参数

通过环境变量自定义回测参数：

```bash
# 回测以太坊，1小时K线
BACKTEST_SYMBOL=ETH/USDT \
BACKTEST_TIMEFRAME=1h \
BACKTEST_START=2022-01-01T00:00:00Z \
BACKTEST_END=2023-12-31T23:59:00Z \
npm run backtest
```

```bash
# 回测BTC，调整资金参数
BACKTEST_INITIAL_CAPITAL=50000 \
BACKTEST_POSITION_USD=50 \
BACKTEST_LEVERAGE=5 \
npm run backtest
```

### 3. 参数敏感性测试

测试不同参数组合的表现：

```bash
# 测试模块B的Z值阈值
PARAMGRID_B_ZLOCAL=2.1,2.3,2.5,2.7 \
PARAMGRID_C_DELTA=300,450,600 \
npm run backtest
```

## 配置参数详解

### 基础参数

| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `BACKTEST_SYMBOL` | `BTC/USDT` | 交易对 |
| `BACKTEST_TIMEFRAME` | `1m` | K线周期 (1m, 3m, 5m, 15m, 1h等) |
| `BACKTEST_START` | `2021-01-01T00:00:00Z` | 回测开始时间 (ISO格式) |
| `BACKTEST_END` | `2023-06-30T23:59:00Z` | 回测结束时间 (ISO格式) |

### 资金参数

| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `BACKTEST_INITIAL_CAPITAL` | `10000` | 初始资金 (美元) |
| `BACKTEST_POSITION_USD` | `10` | 每笔交易金额 (美元) |
| `BACKTEST_LEVERAGE` | `10` | 杠杆倍数 |
| `BACKTEST_FEE_RATE` | `0.0004` | 手续费率 (0.04%) |

### 止损止盈

| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `BACKTEST_STOP_LOSS_PCT` | `0.006` | 止损百分比 (0.6%) |
| `BACKTEST_TAKE_PROFIT_PCT` | `0.012` | 止盈百分比 (1.2%) |

### 滑点配置

| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `BACKTEST_SLIPPAGE_MODE` | `fixed` | 滑点模式 (fixed/dynamic) |
| `BACKTEST_FIXED_SLIPPAGE` | `0.0005` | 固定滑点 (0.05%) |
| `BACKTEST_ATR_PERIOD` | `14` | ATR周期（动态滑点） |
| `BACKTEST_ATR_FACTOR` | `0.1` | ATR因子（动态滑点） |

### 参数网格（敏感性测试）

#### 模块B参数

| 环境变量 | 说明 | 示例 |
|---------|------|------|
| `PARAMGRID_B_ZLOCAL` | 局部Z值阈值 | `2.1,2.3,2.5,2.7` |
| `PARAMGRID_B_ZGLOBAL` | 全局Z值阈值 | `1.8,2.0,2.2` |
| `PARAMGRID_B_GROWTHRATIO` | 环比爆发比率 | `1.8,2.0,2.2` |

#### 模块C参数

| 环境变量 | 说明 | 示例 |
|---------|------|------|
| `PARAMGRID_C_DELTA` | Delta阈值 | `300,450,600` |

## 输出文件

回测完成后，会在 `backend/data/backtest/` 目录下生成以下文件：

### 交易记录CSV

文件名格式: `{symbol}_{segment}_trades.csv`

字段说明：
```
side              - 交易方向 (long/short)
entry_index       - 入场K线索引
exit_index        - 出场K线索引
entry_price       - 入场价格
exit_price        - 出场价格
stop_loss_price   - 止损价格
take_profit_price - 止盈价格
exit_reason       - 出场原因 (stop_loss/take_profit/backtest_end)
gross_return      - 原始收益
leveraged_return  - 杠杆收益
net_return        - 净收益（扣除手续费）
```

### 性能报告JSON

文件名格式: `{symbol}_{segment}_report.json`

包含内容：
- 回测配置
- 性能指标（收益、风险、比率等）
- 蒙特卡洛模拟结果

## 回测模式

### 1. 标准回测（Benchmark Test）

评估策略在完整历史周期的表现。

```bash
npm run backtest
```

输出指标：
- 总收益率 / 年化收益率
- 最大回撤 / 最大回撤持续时间
- 夏普比率 / 索提诺比率 / 卡尔玛比率
- 胜率 / 利润因子 / 盈亏比
- 期望值 / 凯利准则

### 2. 分市场状态回测

分别测试牛市、熊市、震荡市的表现。

默认分段：
- `bull_2021`: 2021年牛市
- `bear_2022`: 2022年熊市
- `range_2023H1`: 2023上半年震荡市

每个分段会生成独立的交易记录和报告。

### 3. 参数敏感性测试

测试策略对关键参数的依赖程度，避免过拟合。

```bash
PARAMGRID_B_ZLOCAL=2.1,2.3,2.5,2.7 \
PARAMGRID_B_ZGLOBAL=1.8,2.0,2.2 \
npm run backtest
```

会生成所有参数组合的测试结果，并按夏普比率排序显示最佳组合。

### 4. 蒙特卡洛模拟

评估策略的运气成分和潜在风险。

当交易数量 >= 10 时自动执行，模拟1000次随机交易顺序：
- 收益分布（P10/P25/P50/P75/P90）
- 最大回撤分布（P50/P90/P95）
- 盈利概率

## 性能指标解读

### 收益指标

- **总收益**: 回测期间的总盈亏
- **年化收益率**: 折算为年度收益率，便于比较
- **期望值**: 每笔交易的平均盈亏

### 风险指标

- **最大回撤**: 从最高点到最低点的最大跌幅
- **夏普比率**: 风险调整后收益，>1为优秀，>2为卓越
- **索提诺比率**: 只考虑下行波动的夏普比率
- **卡尔玛比率**: 年化收益率 / 最大回撤

### 交易质量

- **胜率**: 盈利交易占比，理想范围40-60%
- **利润因子**: 总盈利 / 总亏损，>2为优秀
- **盈亏比**: 平均盈利 / 平均亏损，>2为理想

### 资金管理

- **凯利准则**: 建议的最优仓位百分比
- **保守仓位**: 凯利准则的50%（更安全）

## 实战建议

### 评估策略是否可行

✅ **合格策略**：
- 夏普比率 > 1
- 最大回撤 < 20%
- 利润因子 > 1.5
- 胜率 40-60%
- 盈亏比 > 1.5

⚠️ **需要优化**：
- 夏普比率 < 0.5
- 最大回撤 > 30%
- 利润因子 < 1.2
- 参数敏感性测试波动大

❌ **不可用**：
- 负收益
- 夏普比率 < 0
- 利润因子 < 1

### 参数优化建议

1. **参数稳健性**: 参数微调时收益曲线应平滑，避免断崖式下跌
2. **市场适应性**: 在不同市场状态下都应保持可接受的表现
3. **样本外测试**: 用不同时间段的数据验证策略

### 蒙特卡洛解读

- **盈利概率 > 70%**: 策略较为稳定
- **P95回撤 < 25%**: 极端情况下可接受
- **收益分布**: 如果P10收益为正，说明策略鲁棒性强

## 常见问题

### Q1: 数据不足怎么办？

策略需要720根K线（1分钟约12小时，3分钟约36小时）。如果提示数据不足，请：
- 扩大回测时间范围
- 使用更长的时间周期（如3m、5m）

### Q2: 下载数据很慢？

币安API有限流，首次下载需要时间。数据会自动保存到 `backend/data/klines/`，下次直接使用。

强制重新下载：
```bash
# 删除旧数据文件
rm -rf backend/data/klines/*
npm run backtest
```

### Q3: 回测结果是否可信？

回测系统已尽可能模拟真实交易：
- ✅ 真实的历史价格
- ✅ 0.04%手续费（币安合约taker）
- ✅ 0.05%滑点（固定模式）
- ✅ 精确的止损止盈触发

但仍需注意：
- ⚠️ 历史表现不代表未来
- ⚠️ 实盘可能有网络延迟
- ⚠️ 极端行情可能滑点更大

### Q4: 如何解读分市场状态结果？

理想情况：
- 震荡市：收益最高
- 趋势市：收益可能较低，但最大回撤可控
- 总体：正收益，夏普比率 > 1

如果熊市亏损巨大，说明策略在下跌趋势中有风险，需要优化趋势过滤。

### Q5: 参数敏感性测试显示波动大？

如果参数微调导致收益大幅变化，可能存在过拟合。建议：
- 扩大回测时间范围
- 使用更保守的参数
- 增加策略的鲁棒性设计

## 示例命令

### 完整的回测流程

```bash
# 1. 标准回测（评估基准表现）
npm run backtest

# 2. 分市场状态（验证在不同行情下的表现）
BACKTEST_START=2021-01-01T00:00:00Z \
BACKTEST_END=2023-12-31T23:59:00Z \
npm run backtest

# 3. 参数敏感性（寻找最优参数）
PARAMGRID_B_ZLOCAL=2.1,2.3,2.5,2.7 \
PARAMGRID_C_DELTA=300,450,600 \
npm run backtest

# 4. 验证最优参数（使用找到的最优参数重新回测）
# 假设找到最优参数为 zLocal=2.5, delta=450
# 修改策略代码中的默认参数，然后运行标准回测
npm run backtest
```

### 不同交易对测试

```bash
# BTC
npm run backtest

# ETH
BACKTEST_SYMBOL=ETH/USDT npm run backtest

# SOL
BACKTEST_SYMBOL=SOL/USDT npm run backtest
```

### 不同时间周期测试

```bash
# 1分钟（默认，最精确）
npm run backtest

# 3分钟（策略设计周期）
BACKTEST_TIMEFRAME=3m npm run backtest

# 5分钟（降低交易频率）
BACKTEST_TIMEFRAME=5m npm run backtest

# 1小时（长周期测试）
BACKTEST_TIMEFRAME=1h npm run backtest
```

## 技术细节

### 数据存储

- **K线数据**: `backend/data/klines/` (CSV格式)
- **回测结果**: `backend/data/backtest/` (CSV + JSON)
- **日志文件**: `backend/logs/` (按小时滚动)

### 回测流程

```
1. 加载历史数据 (HistoricalDataLoader)
   ├─ 从本地加载或从币安下载
   ├─ 数据完整性检查
   └─ 计算ATR（如使用动态滑点）

2. 初始化回测引擎 (BacktestEngine)
   ├─ 设置初始资金
   ├─ 配置止损止盈
   └─ 配置滑点和手续费

3. 遍历K线执行策略
   ├─ 模块A: 计算成交量分布
   ├─ 模块B: 检测成交量爆发
   ├─ 模块C: 验证市场条件
   ├─ 模块D: 融合决策
   └─ 执行开仓/平仓

4. 计算性能指标 (PerformanceMetrics)
   ├─ 收益指标
   ├─ 风险指标
   ├─ 交易质量指标
   └─ 蒙特卡洛模拟

5. 生成报告并保存
   ├─ 交易记录CSV
   ├─ 性能报告JSON
   └─ 控制台输出摘要
```

### 策略执行

回测时策略运行在**离线模式**，不访问实时API：
- ✅ 使用提供的历史K线数据
- ✅ 跳过订单簿和资金费率（模块C降级）
- ✅ 完整执行模块A和模块B
- ✅ 精确模拟开仓/平仓/止损/止盈

## 下一步

1. **运行回测**: 使用默认配置运行第一次回测
2. **分析结果**: 查看生成的报告，评估策略表现
3. **参数优化**: 如果需要，进行参数敏感性测试
4. **验证策略**: 在不同市场状态和交易对上验证
5. **小额实盘**: 确认策略可行后，开始小额实盘测试

## 相关文档

- `norm_policy.txt` - 策略原始文档
- `volume_strategy_implementation.md` - 策略实施详解
- `volume_strategy_quickstart.md` - 策略快速指南
- `backtest.txt` - 回测需求文档

## 技术支持

如遇问题，请检查：
1. 日志文件: `backend/logs/`
2. 数据文件是否完整
3. 参数配置是否正确
4. 策略代码是否正常运行

祝回测成功！📊🚀


