# 最终激进参数配置 - 3分钟K线专用

## 问题诊断历程

### 第一次运行（原始参数）
- 边沿触发: 3次
- 交易: 3笔
- 问题: 边沿检测Bug（基于索引而非价格）

### 第二次运行（修复边沿检测Bug后）
- 边沿触发: 83389次 (97%)  ❌ 太多！
- 交易: 5笔
- 问题: 边沿阈值计算错误（基于绝对价格百分比）

### 第三次运行（修复边沿计算逻辑）
- 边沿触发: 2073次 (2.4%) ✓ 合理
- 交易: 0笔  ❌
- 问题: 成交量条件过严，转化率0%

### 第四次运行（当前激进配置）
- 预期边沿触发: 4000-8000次 (5-10%)
- 预期交易: 100-400笔
- 预期胜率: 35-50%

## 激进参数配置详情

### 边沿检测
```javascript
// 边沿范围：价值区宽度的10%
edgeThreshold = (VAH - VAL) * 0.10

// 示例：VAH=30000, VAL=29000
// 价值区宽度 = 1000
// 边沿阈值 = 100
// VAL边沿 = [28900, 29100]  (±100)
// VAH边沿 = [29900, 30100]  (±100)
```

**调整理由**：
- 从5%提升到10%
- 增加边沿触发机会
- 仍在合理范围内（5-10%触发率）

### 成交量参数（激进降低）

| 参数 | 保守值 | 激进值 | 降幅 | 说明 |
|------|--------|--------|------|------|
| P2_LOCAL_Z | 1.8 | **1.2** | -33% | 局部Z值：成交量超过局部均值1.2倍标准差 |
| P3_GLOBAL_Z | 1.5 | **1.0** | -33% | 全局Z值：成交量超过全局均值1倍标准差 |
| P4_VOLUME_RATIO | 1.6 | **1.3** | -19% | 环比：当前成交量是前一根的1.3倍 |
| P5_MA5_RATIO | 1.5 | **1.2** | -20% | 5期均值：当前成交量是5期均值的1.2倍 |
| P6_DIST_STRENGTH | 1.2 | **0.9** | -25% | 分布强度：峰值成交量是全局均值的0.9倍 |
| MIN_SCORE_B | 0.25 | **0.35** | +40% | 最低分数：P1(0.25) + 任意1-2个条件(0.10-0.40) |

### 评分逻辑

**满足条件示例**：

```
场景1（最低通过）：
- P1: 边沿位置 ✓  +0.25
- P5: 5期均值比 ✓ +0.10
总分: 0.35  → 通过 ✓

场景2（较强信号）：
- P1: 边沿位置 ✓    +0.25
- P2: 局部Z值 ✓     +0.20
- P4: 环比爆发 ✓    +0.20
- P8: 时段权重      +0.02
总分: 0.67  → 强信号 ✓✓

场景3（不通过）：
- P1: 边沿位置 ✓  +0.25
- 其他全部未通过
总分: 0.25  → 不通过 ✗
```

**关键点**：
- 必须在边沿位置（P1）
- 必须至少满足1个成交量条件
- 鼓励多条件叠加（分数更高）

## 预期效果

### 量化目标

#### 边沿触发
- **目标**: 4000-8000次 (5-10%)
- **当前**: 10%阈值应该能达到

#### 转化率
- **目标**: 10-25%
- **计算**: 激进参数下，边沿触发中约10-25%能满足成交量条件

#### 交易数量
- **目标**: 200-800笔/2.5年
- **计算**: 
  - 保守: 4000 × 10% / 2(双边) = 200笔
  - 激进: 8000 × 25% / 2(双边) = 1000笔

#### 交易频率
- **平均**: 3-5天一笔
- **最高**: 每天可能1-2笔

### 风险指标目标

| 指标 | 目标范围 | 可接受范围 |
|------|----------|------------|
| 胜率 | 40-50% | 35-55% |
| 年化收益 | 20-40% | 10-50% |
| 夏普比率 | > 1.5 | > 1.0 |
| 最大回撤 | < 12% | < 20% |
| 盈亏比 | 1.5-2.5 | > 1.2 |

## 运行指令

```bash
cd /Users/wangke/project/deeptrade/backend
npm run backtest
```

## 结果判断标准

### ✅ 成功标准
- 交易数: 150-500笔
- 胜率: 38-52%
- 年化收益: > 15%
- 夏普比率: > 1.2
- 最大回撤: < 18%

### ⚠️ 需要调整
- 交易数 < 100：参数仍太严格，继续放宽
- 交易数 > 800：参数太松，可能过度交易
- 胜率 < 35%：策略逻辑有问题，需要重新审视
- 最大回撤 > 25%：风险过高，收紧止损或减少交易频率

### ❌ 失败标准
- 交易数 < 50：参数严重不匹配
- 胜率 < 30%：策略无效
- 年化收益 < 0：策略长期亏损
- 最大回撤 > 30%：风险不可接受

## 如果仍然没有信号

### 选项A：超激进参数（临时测试）
```javascript
P2_LOCAL_Z_THRESHOLD: 0.8,
P3_GLOBAL_Z_THRESHOLD: 0.6,
P4_VOLUME_RATIO: 1.15,
P5_MA5_RATIO: 1.1,
P6_DIST_STRENGTH: 0.7,
MIN_SCORE_B: 0.30,  // 降低到0.30
edgeThreshold: valueAreaRange * 0.15  // 扩大到15%
```

### 选项B：简化策略
只保留P1（边沿）+ P4（环比）或P5（5期均值）中的一个：
```javascript
if (isInEdge && (volumeRatio > 1.2 || ma5Ratio > 1.15)) {
  return 'SIGNAL';
}
```

### 选项C：重新审视策略假设
可能需要考虑：
1. 策略本身是否适合3分钟K线？
2. 价值区边沿在加密货币中是否有效？
3. 是否需要加入趋势过滤器？
4. 止损止盈设置是否合理？

## 技术债务

### 需要优化的地方
1. **价值区计算**：当前基于价格分布，可能需要考虑成交量加权
2. **边沿定义**：固定10%可能不适合所有市场状态，考虑动态调整
3. **Z值计算**：可能需要使用滚动窗口而非固定720根
4. **多空平衡**：当前做多做空比例是否合理？

### 后续改进方向
1. **自适应参数**：根据市场波动性动态调整阈值
2. **市场状态识别**：牛市/熊市/震荡市使用不同参数
3. **多时间框架确认**：加入更高时间周期的趋势确认
4. **机器学习优化**：使用遗传算法或网格搜索优化参数

## 文件修改记录

- `VolumeProfileStrategy.js`: 第24-44行（参数定义）
- `VolumeProfileStrategy.js`: 第322-343行（边沿检测逻辑）
- `VolumeProfileStrategy.js`: 第736-749行（最低分数检查）

## 版本历史

- v1.0: 原始参数（来自2分钟K线文档）
- v2.0: 保守调整（适配3分钟）
- v3.0: 激进调整（当前版本） ✓
- v4.0: （待定）根据回测结果微调

---

**最后更新**: 2024-11-14
**下次回测**: 运行并观察结果，准备微调

